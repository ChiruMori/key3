$().ready(function(){const b="/admin/api/room/";const c=$("#submitBtn");const n=$("#roomSelectTag");const m=$("#locationDropDown");const f=$("#id");const a=$("#errorHint");const g=$("#deleteBtn");let clubRoomDTOs,roomLocationDTOs;let selectingRoom=null;const e=function(){c.off("click");if(selectingRoom.id===-1){f.removeAttr("readonly");let showingObj=utils.formToObj("roomForm");for(let name in showingObj){$("#"+name).val("")}c.on("click",function(){h("POST",function(){let newOption=$('<option value="'+clubRoomDTOs.length+'">'+selectingRoom.name+"</option>");clubRoomDTOs.push(selectingRoom);newOption.insertBefore($("#lastOpt"));newOption.attr("selected",true);d()})});return}f.attr("readonly","true");for(let name in selectingRoom){if(selectingRoom.hasOwnProperty(name)){$("#"+name).val(selectingRoom[name])}}c.on("click",function(){h("PUT",d)})};const d=function(){$("#roomForm input").removeClass("is-invalid");a.text("")};const h=function(p,o){utils.showLoading("Uploading...");let dataToSend=utils.formToObj("roomForm");dataToSend.clubId=GLOBAL_VAL.nowClubId;utils.ajax(b,dataToSend,p,function(q){selectingRoom=q.data;e();if(typeof o==="function"){o()}},function(q){console.log(q);a.text(q.responseJSON.msg);l(q.responseJSON.data)},utils.hideLoading)};g.on("click",function(){let confirmText=prompt("注意，这会同时删除该活动室有关的预约信息（含历史数据），如果您仍要这么做，请输入该活动室名称以确认","");if(confirmText!==selectingRoom.name){alert("您取消了操作，数据仍然是安全的");return}utils.showLoading("DELETING...");utils.ajax(b+GLOBAL_VAL.nowClubId+"/"+selectingRoom.id,{},"DELETE",function(){alert("完成删除，即将自动刷新页面");location.reload()},function(o){console.debug(o);a.text(o.data.msg)})});n.on("change",function(){let index=n.val();selectingRoom=index==="-1"?{id:-1}:clubRoomDTOs[index];e()});const j=function(o){let nowLocation=roomLocationDTOs[o];$("#longitude").val(nowLocation.longitude);$("#latitude").val(nowLocation.latitude)};const l=function(o){if(!o){return}for(let k in o){if(!o.hasOwnProperty(k)){continue}let errorInp=$("#"+k);errorInp.addClass("is-invalid");errorInp.tooltip("dispose");errorInp.tooltip({title:o[k]})}};utils.subscribeEvent(CONST_VAL.clubChangedEventKey,function(o){utils.showLoading();selectingRoom=null;let roomDataPromise=new Promise(function(q,p){utils.ajax(b+o.id,{},"GET",function(r){clubRoomDTOs=r.data;q(r.data)},function(r){console.error(r);p(r.responseJSON);a.text(r.responseJSON.msg)})});let roomLocationPromise=new Promise(function(q,p){utils.ajax(b+"locations/"+o.id,{},"GET",function(r){roomLocationDTOs=r.data;q(r.data)},function(r){console.error(r);p(r.responseJSON);a.text(r.responseJSON.msg)})});Promise.all([roomDataPromise,roomLocationPromise]).then(function(){if(selectingRoom===null){selectingRoom=clubRoomDTOs.length?clubRoomDTOs[0]:{id:-1}}let optionsHTML="";for(let i=0,len=clubRoomDTOs.length;i<len;i++){let dto=clubRoomDTOs[i];optionsHTML+=('<option value="'+i+'">'+dto.name+"</option>\n")}optionsHTML+=('<option id="lastOpt" value="-1">添加活动室</option>\n');n.html(optionsHTML);m.html("");for(let i=0,len=roomLocationDTOs.length;i<len;i++){let newLocationItem=$('<a class="dropdown-item" data-id="'+i+'" href="javascript:">No.'+dto.dataId+"</a>");newLocationItem.on("click",function(){j(this.dataset.id)});m.append(newLocationItem)}if(roomLocationDTOs.length===0){m.html('<p class="text-mute m-0 px-2">无可用坐标</p>')}e();utils.hideLoading()})})});