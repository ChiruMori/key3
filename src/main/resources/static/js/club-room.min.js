/*!
 * Start Bootstrap - SB Admin 2 v4.1.3 (https://startbootstrap.com/theme/sb-admin-2)
 * Copyright 2013-2020 Start Bootstrap
 * Licensed under MIT (https://github.com/StartBootstrap/startbootstrap-sb-admin-2/blob/master/LICENSE)
 */

$().ready(function(){var e="admin/api/room/";const o=$("#submitBtn"),i=$("#roomSelectTag"),a=$("#locationDropDown"),l=$("#id"),s=$("#errorHint"),r=$("#deleteBtn");var u={needSign:!0,available:!0};let c,d,f=null;function p(){if(o.off("click"),-1===f.id){for(var t in l.removeAttr("readonly"),utils.formToObj("roomForm"))$("#"+t).val("");return o.on("click",function(){g("POST",function(){let t=$('<option value="'+c.length+'">'+f.name+"</option>");c.push(f),t.insertBefore($("#lastOpt")),t.attr("selected",!0),m()})}),r.hide(),0}for(var n in l.attr("readonly","true"),f)if(f.hasOwnProperty(n)){let t=$("#"+n);u[n]?t.prop("checked",f[n]):t.val(f[n])}o.on("click",function(){g("PUT",m)}),r.show()}const m=function(){$("#roomForm input").removeClass("is-invalid"),s.text("")},g=function(t,n){utils.showLoading("Uploading...");let o=utils.formToObj("roomForm");o.available=Boolean(o.available),o.needSign=Boolean(o.needSign),o.clubId=GLOBAL_VAL.nowClubId,utils.ajax(e,o,t,function(t){f=t.data,p(),"function"==typeof n&&n()},function(t){console.log(t),s.text(t.responseJSON.msg),v(t.responseJSON.data)},utils.hideLoading)};r.on("click",function(){utils.prompt("删除活动室？","注意，这会同时删除该活动室有关的预约信息（含历史数据），如果您仍要这么做，请输入该活动室名称以确认","text",f.name).then(function(t){t===f.name&&utils.ajax(e+GLOBAL_VAL.nowClubId+"/"+f.id,{},"DELETE",function(){utils.success("操作成功","已删除活动室，即将刷新页面").then(location.reload)},function(t){console.debug(t),s.text(t.data.msg),utils.error("ERROR",t.data.msg)})})}),i.on("change",function(){var t=i.val();f="-1"===t?{id:-1}:c[t],p()});const v=function(n){if(n)for(var o in n)if(n.hasOwnProperty(o)){let t=$("#"+o);t.addClass("is-invalid"),t.tooltip("dispose"),t.tooltip({title:n[o]})}};utils.subscribeEvent(CONST_VAL.clubChangedEventKey,function(t){utils.showLoading(),f=null;var n=new Promise(function(n,o){utils.ajax(e+t.id,{},"GET",function(t){c=t.data,n(t.data)},function(t){console.error(t),o(t.responseJSON),utils.error("获取失败",t.responseJSON.msg),s.text(t.responseJSON.msg)})}),o=new Promise(function(n,o){utils.ajax(e+"locations/"+t.id,{},"GET",function(t){d=t.data,n(t.data)},function(t){console.error(t),o(t.responseJSON),utils.error("失败",t.responseJSON.msg),s.text(t.responseJSON.msg)})});Promise.all([n,o]).then(function(){null===f&&(f=c.length?c[0]:{id:-1});let o="";for(let t=0,n=c.length;t<n;t++){var e=c[t];o+='<option value="'+t+'">'+e.name+"</option>\n"}o+='<option id="lastOpt" value="-1">添加活动室</option>\n',i.html(o),a.html("");for(let n=0,t=d.length;n<t;n++){let t=$('<a class="dropdown-item" data-id="'+n+'" href="javascript:">No.'+dto.dataId+"</a>");t.on("click",function(){!function(t){t=d[t];$("#longitude").val(t.longitude),$("#latitude").val(t.latitude)}(this.dataset.id)}),a.append(t)}0===d.length&&a.html('<p class="text-mute m-0 px-2">无可用坐标</p>'),p(),utils.hideLoading()})})});